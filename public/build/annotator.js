var Showdown={extensions:{}},forEach=Showdown.forEach=function(a,b){if("function"==typeof a.forEach)a.forEach(b);else{var c,d=a.length;for(c=0;d>c;c++)b(a[c],c,a)}},stdExtName=function(a){return a.replace(/[_-]||\s/g,"").toLowerCase()};Showdown.converter=function(a){var b,c,d,e=0,f=[],g=[];if("undefind"!=typeof module&&"undefined"!=typeof exports&&"undefind"!=typeof require){var h=require("fs");if(h){var i=h.readdirSync((__dirname||".")+"/extensions").filter(function(a){return~a.indexOf(".js")}).map(function(a){return a.replace(/\.js$/,"")});Showdown.forEach(i,function(a){var b=stdExtName(a);Showdown.extensions[b]=require("./extensions/"+a)})}}if(this.makeHtml=function(a){return b={},c={},d=[],a=a.replace(/~/g,"~T"),a=a.replace(/\$/g,"~D"),a=a.replace(/\r\n/g,"\n"),a=a.replace(/\r/g,"\n"),a="\n\n"+a+"\n\n",a=M(a),a=a.replace(/^[ \t]+$/gm,""),Showdown.forEach(f,function(b){a=k(b,a)}),a=z(a),a=m(a),a=l(a),a=o(a),a=K(a),a=a.replace(/~D/g,"$$"),a=a.replace(/~T/g,"~"),Showdown.forEach(g,function(b){a=k(b,a)}),a},a&&a.extensions){var j=this;Showdown.forEach(a.extensions,function(a){if("string"==typeof a&&(a=Showdown.extensions[stdExtName(a)]),"function"!=typeof a)throw"Extension '"+a+"' could not be loaded.  It was either not found or is not a valid extension.";Showdown.forEach(a(j),function(a){a.type?"language"===a.type||"lang"===a.type?f.push(a):("output"===a.type||"html"===a.type)&&g.push(a):g.push(a)})})}var w,k=function(a,b){if(a.regex){var c=new RegExp(a.regex,"g");return b.replace(c,a.replace)}return a.filter?a.filter(b):void 0},l=function(a){return a+="~0",a=a.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|(?=~0))/gm,function(a,d,e,f,g){return d=d.toLowerCase(),b[d]=G(e),f?f+g:(g&&(c[d]=g.replace(/"/g,"&quot;")),"")}),a=a.replace(/~0/,"")},m=function(a){a=a.replace(/\n/g,"\n\n");return a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,n),a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|style|section|header|footer|nav|article|aside)\b[^\r]*?<\/\2>[ \t]*(?=\n+)\n)/gm,n),a=a.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,n),a=a.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,n),a=a.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,n),a=a.replace(/\n\n/g,"\n")},n=function(a,b){var c=b;return c=c.replace(/\n\n/g,"\n"),c=c.replace(/^\n/,""),c=c.replace(/\n+$/g,""),c="\n\n~K"+(d.push(c)-1)+"K\n\n"},o=function(a){a=v(a);var b=A("<hr />");return a=a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\-[ ]?){3,}[ \t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\_[ ]?){3,}[ \t]*$/gm,b),a=x(a),a=y(a),a=E(a),a=m(a),a=F(a)},p=function(a){return a=B(a),a=q(a),a=H(a),a=t(a),a=r(a),a=I(a),a=G(a),a=D(a),a=a.replace(/  +\n/g," <br />\n")},q=function(a){var b=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return a=a.replace(b,function(a){var b=a.replace(/(.)<\/?code>(?=.)/g,"$1`");return b=N(b,"\\`*_")})},r=function(a){return a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,s),a=a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?(?:\(.*?\).*?)?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,s),a=a.replace(/(\[([^\[\]]+)\])()()()()()/g,s)},s=function(a,d,e,f,g,h,i,j){void 0==j&&(j="");var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(""==n)if(""==m&&(m=l.toLowerCase().replace(/ ?\n/g," ")),n="#"+m,void 0!=b[m])n=b[m],void 0!=c[m]&&(o=c[m]);else{if(!(k.search(/\(\s*\)$/m)>-1))return k;n=""}n=N(n,"*_");var p='<a href="'+n+'"';return""!=o&&(o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=' title="'+o+'"'),p+=">"+l+"</a>"},t=function(a){return a=a.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,u),a=a.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,u)},u=function(a,d,e,f,g,h,i,j){var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(o||(o=""),""==n){if(""==m&&(m=l.toLowerCase().replace(/ ?\n/g," ")),n="#"+m,void 0==b[m])return k;n=b[m],void 0!=c[m]&&(o=c[m])}l=l.replace(/"/g,"&quot;"),n=N(n,"*_");var p='<img src="'+n+'" alt="'+l+'"';return o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=' title="'+o+'"',p+=" />"},v=function(a){function b(a){return a.replace(/[^\w]/g,"").toLowerCase()}return a=a.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(a,c){return A('<h1 id="'+b(c)+'">'+p(c)+"</h1>")}),a=a.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(a,c){return A('<h2 id="'+b(c)+'">'+p(c)+"</h2>")}),a=a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(a,c,d){var e=c.length;return A("<h"+e+' id="'+b(d)+'">'+p(d)+"</h"+e+">")})},x=function(a){a+="~0";var b=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return e?a=a.replace(b,function(a,b,c){var d=b,e=c.search(/[*+-]/g)>-1?"ul":"ol";d=d.replace(/\n{2,}/g,"\n\n\n");var f=w(d);return f=f.replace(/\s+$/,""),f="<"+e+">"+f+"</"+e+">\n"}):(b=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,a=a.replace(b,function(a,b,c,d){var e=b,f=c,g=d.search(/[*+-]/g)>-1?"ul":"ol",f=f.replace(/\n{2,}/g,"\n\n\n"),h=w(f);return h=e+"<"+g+">\n"+h+"</"+g+">\n"})),a=a.replace(/~0/,"")};w=function(a){return e++,a=a.replace(/\n{2,}$/,"\n"),a+="~0",a=a.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(a,b,c,d,e){var f=e,g=b;return g||f.search(/\n{2,}/)>-1?f=o(L(f)):(f=x(L(f)),f=f.replace(/\n$/,""),f=p(f)),"<li>"+f+"</li>\n"}),a=a.replace(/~0/g,""),e--,a};var y=function(a){return a+="~0",a=a.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(a,b,c){var d=b,e=c;return d=C(L(d)),d=M(d),d=d.replace(/^\n+/g,""),d=d.replace(/\n+$/g,""),d="<pre><code>"+d+"\n</code></pre>",A(d)+e}),a=a.replace(/~0/,"")},z=function(a){return a+="~0",a=a.replace(/(?:^|\n)```(.*)\n([\s\S]*?)\n```/g,function(a,b,c){var d=b,e=c;return e=C(e),e=M(e),e=e.replace(/^\n+/g,""),e=e.replace(/\n+$/g,""),e="<pre><code"+(d?' class="'+d+'"':"")+">"+e+"\n</code></pre>",A(e)}),a=a.replace(/~0/,"")},A=function(a){return a=a.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(d.push(a)-1)+"K\n\n"},B=function(a){return a=a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(a,b,c,d,e){var f=d;return f=f.replace(/^([ \t]*)/g,""),f=f.replace(/[ \t]*$/g,""),f=C(f),b+"<code>"+f+"</code>"})},C=function(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=N(a,"*_{}[]\\",!1)},D=function(a){return a=a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[*_]*)\1/g,"<strong>$2</strong>"),a=a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")},E=function(a){return a=a.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(a,b){var c=b;return c=c.replace(/^[ \t]*>[ \t]?/gm,"~0"),c=c.replace(/~0/g,""),c=c.replace(/^[ \t]+$/gm,""),c=o(c),c=c.replace(/(^|\n)/g,"$1  "),c=c.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(a,b){var c=b;return c=c.replace(/^  /gm,"~0"),c=c.replace(/~0/g,"")}),A("<blockquote>\n"+c+"\n</blockquote>")})},F=function(a){a=a.replace(/^\n+/g,""),a=a.replace(/\n+$/g,"");for(var b=a.split(/\n{2,}/g),c=[],e=b.length,f=0;e>f;f++){var g=b[f];g.search(/~K(\d+)K/g)>=0?c.push(g):g.search(/\S/)>=0&&(g=p(g),g=g.replace(/^([ \t]*)/g,"<p>"),g+="</p>",c.push(g))}e=c.length;for(var f=0;e>f;f++)for(;c[f].search(/~K(\d+)K/)>=0;){var h=d[RegExp.$1];h=h.replace(/\$/g,"$$$$"),c[f]=c[f].replace(/~K\d+K/,h)}return c.join("\n\n")},G=function(a){return a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),a=a.replace(/<(?![a-z\/?\$!])/gi,"&lt;")},H=function(a){return a=a.replace(/\\(\\)/g,O),a=a.replace(/\\([`*_{}\[\]()>#+-.!])/g,O)},I=function(a){return a=a.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>'),a=a.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(a,b){return J(K(b))})},J=function(a){var b=[function(a){return"&#"+a.charCodeAt(0)+";"},function(a){return"&#x"+a.charCodeAt(0).toString(16)+";"},function(a){return a}];return a="mailto:"+a,a=a.replace(/./g,function(a){if("@"==a)a=b[Math.floor(2*Math.random())](a);else if(":"!=a){var c=Math.random();a=c>.9?b[2](a):c>.45?b[1](a):b[0](a)}return a}),a='<a href="'+a+'">'+a+"</a>",a=a.replace(/">.+:/g,'">')},K=function(a){return a=a.replace(/~E(\d+)E/g,function(a,b){var c=parseInt(b);return String.fromCharCode(c)})},L=function(a){return a=a.replace(/^(\t|[ ]{1,4})/gm,"~0"),a=a.replace(/~0/g,"")},M=function(a){return a=a.replace(/\t(?=\t)/g,"    "),a=a.replace(/\t/g,"~A~B"),a=a.replace(/~B(.+?)~A/g,function(a,b,c){for(var d=b,e=4-d.length%4,f=0;e>f;f++)d+=" ";return d}),a=a.replace(/~A/g,"    "),a=a.replace(/~B/g,"")},N=function(a,b,c){var d="(["+b.replace(/([\[\]\\])/g,"\\$1")+"])";c&&(d="\\\\"+d);var e=new RegExp(d,"g");return a=a.replace(e,O)},O=function(a,b){var c=b.charCodeAt(0);return"~E"+c+"E"}},"undefined"!=typeof module&&(module.exports=Showdown),"function"==typeof define&&define.amd&&define("showdown",function(){return Showdown}),!function(){var $,Annotator,Delegator,LinkParser,Range,Util,base64Decode,base64UrlDecode,createDateFromISO8601,findChild,fn,functions,g,getNodeName,getNodePosition,gettext,parseToken,simpleXPathJQuery,simpleXPathPure,_Annotator,_gettext,_i,_j,_len,_len1,_ref,_ref1,_t,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};if(simpleXPathJQuery=function(relativeRoot){var jq;return jq=this.map(function(){var elem,idx,path,tagName;for(path="",elem=this;(null!=elem?elem.nodeType:void 0)===Node.ELEMENT_NODE&&elem!==relativeRoot;)tagName=elem.tagName.replace(":","\\:"),idx=$(elem.parentNode).children(tagName).index(elem)+1,idx="["+idx+"]",path="/"+elem.tagName.toLowerCase()+idx+path,elem=elem.parentNode;return path}),jq.get()},simpleXPathPure=function(relativeRoot){var getPathSegment,getPathTo,jq,rootNode;return getPathSegment=function(node){var name,pos;return name=getNodeName(node),pos=getNodePosition(node),""+name+"["+pos+"]"},rootNode=relativeRoot,getPathTo=function(node){var xpath;for(xpath="";node!==rootNode;){if(null==node)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+rootNode);xpath=getPathSegment(node)+"/"+xpath,node=node.parentNode}return xpath="/"+xpath,xpath=xpath.replace(/\/$/,"")},jq=this.map(function(){var path;return path=getPathTo(this)}),jq.get()},findChild=function(node,type,index){var child,children,found,name,_i,_len;if(!node.hasChildNodes())throw new Error("XPath error: node has no children!");for(children=node.childNodes,found=0,_i=0,_len=children.length;_len>_i;_i++)if(child=children[_i],name=getNodeName(child),name===type&&(found+=1,found===index))return child;throw new Error("XPath error: wanted child not found.")},getNodeName=function(node){var nodeName;switch(nodeName=node.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return nodeName}},getNodePosition=function(node){var pos,tmp;for(pos=0,tmp=node;tmp;)tmp.nodeName===node.nodeName&&pos++,tmp=tmp.previousSibling;return pos},gettext=null,"undefined"!=typeof Gettext&&null!==Gettext?(_gettext=new Gettext({domain:"annotator"}),gettext=function(msgid){return _gettext.gettext(msgid)}):gettext=function(msgid){return msgid},_t=function(msgid){return gettext(msgid)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(_ref=jQuery.fn)?_ref.jquery:void 0)||console.error(_t("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(_t("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),$=jQuery,Util={},Util.flatten=function(array){var flatten;return(flatten=function(ary){var el,flat,_i,_len;for(flat=[],_i=0,_len=ary.length;_len>_i;_i++)el=ary[_i],flat=flat.concat(el&&$.isArray(el)?flatten(el):el);return flat})(array)},Util.contains=function(parent,child){var node;for(node=child;null!=node;){if(node===parent)return!0;node=node.parentNode}return!1},Util.getTextNodes=function(jq){var getTextNodes;return getTextNodes=function(node){var nodes;if(node&&node.nodeType!==Node.TEXT_NODE){if(nodes=[],node.nodeType!==Node.COMMENT_NODE)for(node=node.lastChild;node;)nodes.push(getTextNodes(node)),node=node.previousSibling;return nodes.reverse()}return node},jq.map(function(){return Util.flatten(getTextNodes(this))})},Util.getLastTextNodeUpTo=function(n){var result;switch(n.nodeType){case Node.TEXT_NODE:return n;case Node.ELEMENT_NODE:if(null!=n.lastChild&&(result=Util.getLastTextNodeUpTo(n.lastChild),null!=result))return result}return n=n.previousSibling,null!=n?Util.getLastTextNodeUpTo(n):null},Util.getFirstTextNodeNotBefore=function(n){var result;switch(n.nodeType){case Node.TEXT_NODE:return n;case Node.ELEMENT_NODE:if(null!=n.firstChild&&(result=Util.getFirstTextNodeNotBefore(n.firstChild),null!=result))return result}return n=n.nextSibling,null!=n?Util.getFirstTextNodeNotBefore(n):null},Util.readRangeViaSelection=function(range){var sel;return sel=Util.getGlobal().getSelection(),sel.removeAllRanges(),sel.addRange(range.toRange()),sel.toString()},Util.xpathFromNode=function(el,relativeRoot){var exception,result;try{result=simpleXPathJQuery.call(el,relativeRoot)}catch(_error){exception=_error,console.log("jQuery-based XPath construction failed! Falling back to manual."),result=simpleXPathPure.call(el,relativeRoot)}return result},Util.nodeFromXPath=function(xp,root){var idx,name,node,step,steps,_i,_len,_ref1;for(steps=xp.substring(1).split("/"),node=root,_i=0,_len=steps.length;_len>_i;_i++)step=steps[_i],_ref1=step.split("["),name=_ref1[0],idx=_ref1[1],idx=null!=idx?parseInt((null!=idx?idx.split("]"):void 0)[0]):1,node=findChild(node,name.toLowerCase(),idx);return node},Util.escape=function(html){return html.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},Util.uuid=function(){var counter;return counter=0,function(){return counter++}}(),Util.getGlobal=function(){return function(){return this}()},Util.maxZIndex=function($elements){var all,el;return all=function(){var _i,_len,_results;for(_results=[],_i=0,_len=$elements.length;_len>_i;_i++)el=$elements[_i],"static"===$(el).css("position")?_results.push(-1):_results.push(parseInt($(el).css("z-index"),10)||-1);return _results}(),Math.max.apply(Math,all)},Util.mousePosition=function(e,offsetEl){var offset,_ref1;return"absolute"!==(_ref1=$(offsetEl).css("position"))&&"fixed"!==_ref1&&"relative"!==_ref1&&(offsetEl=$(offsetEl).offsetParent()[0]),offset=$(offsetEl).offset(),{top:e.pageY-offset.top,left:e.pageX-offset.left}},Util.preventEventDefault=function(event){return null!=event&&"function"==typeof event.preventDefault?event.preventDefault():void 0},functions=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(name){return console.log("GROUP: ",name)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),_i=0,_len=functions.length;_len>_i;_i++)fn=functions[_i],null==console[fn]&&(console[fn]=function(){return console.log(_t("Not implemented:")+(" console."+name))});else{for(this.console={},_j=0,_len1=functions.length;_len1>_j;_j++)fn=functions[_j],this.console[fn]=function(){};this.console.error=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],alert("ERROR: "+args.join(", "))},this.console.warn=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],alert("WARNING: "+args.join(", "))}}Delegator=function(){function Delegator(element,options){this.options=$.extend(!0,{},this.options,options),this.element=$(element),this._closures={},this.on=this.subscribe,this.addEvents()}return Delegator.prototype.events={},Delegator.prototype.options={},Delegator.prototype.element=null,Delegator.prototype.addEvents=function(){var event,_k,_len2,_ref1,_results;for(_ref1=Delegator._parseEvents(this.events),_results=[],_k=0,_len2=_ref1.length;_len2>_k;_k++)event=_ref1[_k],_results.push(this._addEvent(event.selector,event.event,event.functionName));return _results},Delegator.prototype.removeEvents=function(){var event,_k,_len2,_ref1,_results;for(_ref1=Delegator._parseEvents(this.events),_results=[],_k=0,_len2=_ref1.length;_len2>_k;_k++)event=_ref1[_k],_results.push(this._removeEvent(event.selector,event.event,event.functionName));return _results},Delegator.prototype._addEvent=function(selector,event,functionName){var closure;return closure=function(_this){return function(){return _this[functionName].apply(_this,arguments)}}(this),""===selector&&Delegator._isCustomEvent(event)?this.subscribe(event,closure):this.element.delegate(selector,event,closure),this._closures[""+selector+"/"+event+"/"+functionName]=closure,this},Delegator.prototype._removeEvent=function(selector,event,functionName){var closure;return closure=this._closures[""+selector+"/"+event+"/"+functionName],""===selector&&Delegator._isCustomEvent(event)?this.unsubscribe(event,closure):this.element.undelegate(selector,event,closure),delete this._closures[""+selector+"/"+event+"/"+functionName],this},Delegator.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},Delegator.prototype.subscribe=function(event,callback){var closure;return closure=function(){return callback.apply(this,[].slice.call(arguments,1))},closure.guid=callback.guid=$.guid+=1,this.element.bind(event,closure),this},Delegator.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},Delegator}(),Delegator._parseEvents=function(eventsObj){var event,events,functionName,sel,selector,_k,_ref1;events=[];for(sel in eventsObj)functionName=eventsObj[sel],_ref1=sel.split(" "),selector=2<=_ref1.length?__slice.call(_ref1,0,_k=_ref1.length-1):(_k=0,[]),event=_ref1[_k++],events.push({selector:selector.join(" "),event:event,functionName:functionName});return events},Delegator.natives=function(){var key,specials,val;return specials=function(){var _ref1,_results;_ref1=jQuery.event.special,_results=[];for(key in _ref1)__hasProp.call(_ref1,key)&&(val=_ref1[key],_results.push(key));return _results}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(specials)}(),Delegator._isCustomEvent=function(event){return event=event.split(".")[0],-1===$.inArray(event,Delegator.natives)},Range={},Range.sniff=function(r){return null!=r.commonAncestorContainer?new Range.BrowserRange(r):"string"==typeof r.start?new Range.SerializedRange(r):r.start&&"object"==typeof r.start?new Range.NormalizedRange(r):(console.error(_t("Could not sniff range type")),!1)},Range.nodeFromXPath=function(xpath,root){var customResolver,evaluateXPath,namespace,node,segment;return null==root&&(root=document),evaluateXPath=function(xp,nsResolver){var exception;null==nsResolver&&(nsResolver=null);try{return document.evaluate("."+xp,root,nsResolver,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(_error){return exception=_error,console.log("XPath evaluation failed."),console.log("Trying fallback..."),Util.nodeFromXPath(xp,root)}},$.isXMLDoc(document.documentElement)?(customResolver=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),node=evaluateXPath(xpath,customResolver),node||(xpath=function(){var _k,_len2,_ref1,_results;for(_ref1=xpath.split("/"),_results=[],_k=0,_len2=_ref1.length;_len2>_k;_k++)segment=_ref1[_k],segment&&-1===segment.indexOf(":")?_results.push(segment.replace(/^([a-z]+)/,"xhtml:$1")):_results.push(segment);return _results}().join("/"),namespace=document.lookupNamespaceURI(null),customResolver=function(ns){return"xhtml"===ns?namespace:document.documentElement.getAttribute("xmlns:"+ns)},node=evaluateXPath(xpath,customResolver)),node):evaluateXPath(xpath)},Range.RangeError=function(_super){function RangeError(type,message,parent){this.type=type,this.message=message,this.parent=null!=parent?parent:null,RangeError.__super__.constructor.call(this,this.message)}return __extends(RangeError,_super),RangeError}(Error),Range.BrowserRange=function(){function BrowserRange(obj){this.commonAncestorContainer=obj.commonAncestorContainer,this.startContainer=obj.startContainer,this.startOffset=obj.startOffset,this.endContainer=obj.endContainer,this.endOffset=obj.endOffset}return BrowserRange.prototype.normalize=function(root){var n,node,nr,r;if(this.tainted)return console.error(_t("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,r={},this.startContainer.nodeType===Node.ELEMENT_NODE?(r.start=Util.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),r.startOffset=0):(r.start=this.startContainer,r.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(node=this.endContainer.childNodes[this.endOffset],null!=node){for(n=node;null!=n&&n.nodeType!==Node.TEXT_NODE;)n=n.firstChild;null!=n&&(r.end=n,r.endOffset=0)}null==r.end&&(node=this.endContainer.childNodes[this.endOffset-1],r.end=Util.getLastTextNodeUpTo(node),r.endOffset=r.end.nodeValue.length)}else r.end=this.endContainer,r.endOffset=this.endOffset;for(nr={},r.startOffset>0?r.start.nodeValue.length>r.startOffset?nr.start=r.start.splitText(r.startOffset):nr.start=r.start.nextSibling:nr.start=r.start,r.start===r.end?(nr.start.nodeValue.length>r.endOffset-r.startOffset&&nr.start.splitText(r.endOffset-r.startOffset),nr.end=nr.start):(r.end.nodeValue.length>r.endOffset&&r.end.splitText(r.endOffset),nr.end=r.end),nr.commonAncestor=this.commonAncestorContainer;nr.commonAncestor.nodeType!==Node.ELEMENT_NODE;)nr.commonAncestor=nr.commonAncestor.parentNode;return new Range.NormalizedRange(nr)},BrowserRange.prototype.serialize=function(root,ignoreSelector){return this.normalize(root).serialize(root,ignoreSelector)},BrowserRange}(),Range.NormalizedRange=function(){function NormalizedRange(obj){this.commonAncestor=obj.commonAncestor,this.start=obj.start,this.end=obj.end}return NormalizedRange.prototype.normalize=function(root){return this},NormalizedRange.prototype.limit=function(bounds){var nodes,parent,startParents,_k,_len2,_ref1;if(nodes=$.grep(this.textNodes(),function(node){return node.parentNode===bounds||$.contains(bounds,node.parentNode)}),!nodes.length)return null;for(this.start=nodes[0],this.end=nodes[nodes.length-1],startParents=$(this.start).parents(),_ref1=$(this.end).parents(),_k=0,_len2=_ref1.length;_len2>_k;_k++)if(parent=_ref1[_k],-1!==startParents.index(parent)){this.commonAncestor=parent;break}return this},NormalizedRange.prototype.serialize=function(root,ignoreSelector){var end,serialization,start;return serialization=function(node,isEnd){var n,nodes,offset,origParent,textNodes,xpath,_k,_len2;for(origParent=ignoreSelector?$(node).parents(":not("+ignoreSelector+")").eq(0):$(node).parent(),xpath=Util.xpathFromNode(origParent,root)[0],textNodes=Util.getTextNodes(origParent),nodes=textNodes.slice(0,textNodes.index(node)),offset=0,_k=0,_len2=nodes.length;_len2>_k;_k++)n=nodes[_k],offset+=n.nodeValue.length;return isEnd?[xpath,offset+node.nodeValue.length]:[xpath,offset]},start=serialization(this.start),end=serialization(this.end,!0),new Range.SerializedRange({start:start[0],end:end[0],startOffset:start[1],endOffset:end[1]})},NormalizedRange.prototype.text=function(){var node;return function(){var _k,_len2,_ref1,_results;for(_ref1=this.textNodes(),_results=[],_k=0,_len2=_ref1.length;_len2>_k;_k++)node=_ref1[_k],_results.push(node.nodeValue);return _results}.call(this).join("")},NormalizedRange.prototype.textNodes=function(){var end,start,textNodes,_ref1;return textNodes=Util.getTextNodes($(this.commonAncestor)),_ref1=[textNodes.index(this.start),textNodes.index(this.end)],start=_ref1[0],end=_ref1[1],$.makeArray(textNodes.slice(start,+end+1||9e9))},NormalizedRange.prototype.toRange=function(){var range;return range=document.createRange(),range.setStartBefore(this.start),range.setEndAfter(this.end),range},NormalizedRange}(),Range.SerializedRange=function(){function SerializedRange(obj){this.start=obj.start,this.startOffset=obj.startOffset,this.end=obj.end,this.endOffset=obj.endOffset}return SerializedRange.prototype.normalize=function(root){var contains,e,length,node,p,range,targetOffset,tn,_k,_l,_len2,_len3,_ref1,_ref2;for(range={},_ref1=["start","end"],_k=0,_len2=_ref1.length;_len2>_k;_k++){p=_ref1[_k];try{node=Range.nodeFromXPath(this[p],root)}catch(_error){throw e=_error,new Range.RangeError(p,"Error while finding "+p+" node: "+this[p]+": "+e,e)}if(!node)throw new Range.RangeError(p,"Couldn't find "+p+" node: "+this[p]);for(length=0,targetOffset=this[p+"Offset"],"end"===p&&targetOffset--,_ref2=Util.getTextNodes($(node)),_l=0,_len3=_ref2.length;_len3>_l;_l++){if(tn=_ref2[_l],length+tn.nodeValue.length>targetOffset){range[p+"Container"]=tn,range[p+"Offset"]=this[p+"Offset"]-length;break}length+=tn.nodeValue.length}if(null==range[p+"Offset"])throw new Range.RangeError(""+p+"offset","Couldn't find offset "+this[p+"Offset"]+" in element "+this[p])}return contains=null==document.compareDocumentPosition?function(a,b){return a.contains(b)}:function(a,b){return 16&a.compareDocumentPosition(b)},$(range.startContainer).parents().each(function(){return contains(this,range.endContainer)?(range.commonAncestorContainer=this,!1):void 0}),new Range.BrowserRange(range).normalize(root)},SerializedRange.prototype.serialize=function(root,ignoreSelector){return this.normalize(root).serialize(root,ignoreSelector)},SerializedRange.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},SerializedRange}(),_Annotator=this.Annotator,Annotator=function(_super){function Annotator(element,options){return this.onDeleteAnnotation=__bind(this.onDeleteAnnotation,this),this.onEditAnnotation=__bind(this.onEditAnnotation,this),this.onAdderClick=__bind(this.onAdderClick,this),this.onAdderMousedown=__bind(this.onAdderMousedown,this),this.onHighlightMouseover=__bind(this.onHighlightMouseover,this),this.checkForEndSelection=__bind(this.checkForEndSelection,this),this.checkForStartSelection=__bind(this.checkForStartSelection,this),this.clearViewerHideTimer=__bind(this.clearViewerHideTimer,this),this.startViewerHideTimer=__bind(this.startViewerHideTimer,this),this.showViewer=__bind(this.showViewer,this),this.onEditorSubmit=__bind(this.onEditorSubmit,this),this.onEditorHide=__bind(this.onEditorHide,this),this.showEditor=__bind(this.showEditor,this),Annotator.__super__.constructor.apply(this,arguments),this.plugins={},Annotator.supported()?(this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=$(this.html.adder).appendTo(this.wrapper).hide(),void Annotator._instances.push(this)):this}return __extends(Annotator,_super),Annotator.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},Annotator.prototype.html={adder:'<div class="annotator-adder"><button>'+_t("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},Annotator.prototype.options={readOnly:!1},Annotator.prototype.plugins={},Annotator.prototype.editor=null,Annotator.prototype.viewer=null,Annotator.prototype.selectedRanges=null,Annotator.prototype.mouseIsDown=!1,Annotator.prototype.ignoreMouseup=!1,Annotator.prototype.viewerHideTimer=null,Annotator.prototype._setupWrapper=function(){return this.wrapper=$(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},Annotator.prototype._setupViewer=function(){return this.viewer=new Annotator.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(_this){return function(field,annotation){return annotation.text?$(field).html(Util.escape(annotation.text)):$(field).html("<i>"+_t("No Comment")+"</i>"),_this.publish("annotationViewerTextField",[field,annotation])}}(this)}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},Annotator.prototype._setupEditor=function(){return this.editor=new Annotator.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:_t("Comments")+"…",load:function(field,annotation){return $(field).find("textarea").val(annotation.text||"")},submit:function(field,annotation){return annotation.text=$(field).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},Annotator.prototype._setupDocumentEvents=function(){return $(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},Annotator.prototype._setupDynamicStyle=function(){var max,sel,style,x;return style=$("#annotator-dynamic-style"),style.length||(style=$('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),sel="*"+function(){var _k,_len2,_ref1,_results;for(_ref1=["adder","outer","notice","filter"],_results=[],_k=0,_len2=_ref1.length;_len2>_k;_k++)x=_ref1[_k],_results.push(":not(.annotator-"+x+")");return _results}().join(""),max=Util.maxZIndex($(document.body).find(sel)),max=Math.max(max,1e3),style.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(max+20)+";","}",".annotator-filter {","  z-index: "+(max+10)+";","}"].join("\n")),this},Annotator.prototype.destroy=function(){var idx,name,plugin,_ref1;$(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),$("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return $(this).contents().insertBefore(this),$(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),_ref1=this.plugins;for(name in _ref1)plugin=_ref1[name],this.plugins[name].destroy();return this.removeEvents(),idx=Annotator._instances.indexOf(this),-1!==idx?Annotator._instances.splice(idx,1):void 0},Annotator.prototype.getSelectedRanges=function(){var browserRange,i,normedRange,r,ranges,rangesToIgnore,selection,_k,_len2;for(selection=Util.getGlobal().getSelection(),ranges=[],rangesToIgnore=[],selection.isCollapsed||(ranges=function(){var _k,_ref1,_results;for(_results=[],i=_k=0,_ref1=selection.rangeCount;_ref1>=0?_ref1>_k:_k>_ref1;i=_ref1>=0?++_k:--_k)r=selection.getRangeAt(i),browserRange=new Range.BrowserRange(r),normedRange=browserRange.normalize().limit(this.wrapper[0]),null===normedRange&&rangesToIgnore.push(r),_results.push(normedRange);return _results}.call(this),selection.removeAllRanges()),_k=0,_len2=rangesToIgnore.length;_len2>_k;_k++)r=rangesToIgnore[_k],selection.addRange(r);return $.grep(ranges,function(range){return range&&selection.addRange(range.toRange()),range})},Annotator.prototype.createAnnotation=function(){var annotation;return annotation={},this.publish("beforeAnnotationCreated",[annotation]),annotation},
Annotator.prototype.setupAnnotation=function(annotation){var e,normed,normedRanges,r,root,_k,_l,_len2,_len3,_ref1;for(root=this.wrapper[0],annotation.ranges||(annotation.ranges=this.selectedRanges),normedRanges=[],_ref1=annotation.ranges,_k=0,_len2=_ref1.length;_len2>_k;_k++){r=_ref1[_k];try{normedRanges.push(Range.sniff(r).normalize(root))}catch(_error){if(e=_error,!(e instanceof Range.RangeError))throw e;this.publish("rangeNormalizeFail",[annotation,r,e])}}for(annotation.quote=[],annotation.ranges=[],annotation.highlights=[],_l=0,_len3=normedRanges.length;_len3>_l;_l++)normed=normedRanges[_l],annotation.quote.push($.trim(normed.text())),annotation.ranges.push(normed.serialize(this.wrapper[0],".annotator-hl")),$.merge(annotation.highlights,this.highlightRange(normed));return annotation.quote=annotation.quote.join(" / "),$(annotation.highlights).data("annotation",annotation),annotation},Annotator.prototype.updateAnnotation=function(annotation){return this.publish("beforeAnnotationUpdated",[annotation]),this.publish("annotationUpdated",[annotation]),annotation},Annotator.prototype.deleteAnnotation=function(annotation){var child,h,_k,_len2,_ref1;if(null!=annotation.highlights)for(_ref1=annotation.highlights,_k=0,_len2=_ref1.length;_len2>_k;_k++)h=_ref1[_k],null!=h.parentNode&&(child=h.childNodes[0],$(h).replaceWith(h.childNodes));return this.publish("annotationDeleted",[annotation]),annotation},Annotator.prototype.loadAnnotations=function(annotations){var clone,loader;return null==annotations&&(annotations=[]),loader=function(_this){return function(annList){var n,now,_k,_len2;for(null==annList&&(annList=[]),now=annList.splice(0,10),_k=0,_len2=now.length;_len2>_k;_k++)n=now[_k],_this.setupAnnotation(n);return annList.length>0?setTimeout(function(){return loader(annList)},10):_this.publish("annotationsLoaded",[clone])}}(this),clone=annotations.slice(),loader(annotations),this},Annotator.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(_t("Can't dump annotations without Store plugin.")),!1)},Annotator.prototype.highlightRange=function(normedRange,cssClass){var hl,node,white,_k,_len2,_ref1,_results;for(null==cssClass&&(cssClass="annotator-hl"),white=/^\s*$/,hl=$("<span class='"+cssClass+"'></span>"),_ref1=normedRange.textNodes(),_results=[],_k=0,_len2=_ref1.length;_len2>_k;_k++)node=_ref1[_k],white.test(node.nodeValue)||_results.push($(node).wrapAll(hl).parent().show()[0]);return _results},Annotator.prototype.highlightRanges=function(normedRanges,cssClass){var highlights,r,_k,_len2;for(null==cssClass&&(cssClass="annotator-hl"),highlights=[],_k=0,_len2=normedRanges.length;_len2>_k;_k++)r=normedRanges[_k],$.merge(highlights,this.highlightRange(r,cssClass));return highlights},Annotator.prototype.addPlugin=function(name,options){var klass,_base;return this.plugins[name]?console.error(_t("You cannot have more than one instance of any plugin.")):(klass=Annotator.Plugin[name],"function"==typeof klass?(this.plugins[name]=new klass(this.element[0],options),this.plugins[name].annotator=this,"function"==typeof(_base=this.plugins[name]).pluginInit&&_base.pluginInit()):console.error(_t("Could not load ")+name+_t(" plugin. Have you included the appropriate <script> tag?"))),this},Annotator.prototype.showEditor=function(annotation,location){return this.editor.element.css(location),this.editor.load(annotation),this.publish("annotationEditorShown",[this.editor,annotation]),this},Annotator.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},Annotator.prototype.onEditorSubmit=function(annotation){return this.publish("annotationEditorSubmit",[this.editor,annotation])},Annotator.prototype.showViewer=function(annotations,location){return this.viewer.element.css(location),this.viewer.load(annotations),this.publish("annotationViewerShown",[this.viewer,annotations])},Annotator.prototype.startViewerHideTimer=function(){return this.viewerHideTimer?void 0:this.viewerHideTimer=setTimeout(this.viewer.hide,250)},Annotator.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},Annotator.prototype.checkForStartSelection=function(event){return event&&this.isAnnotator(event.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},Annotator.prototype.checkForEndSelection=function(event){var container,range,_k,_len2,_ref1;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),_ref1=this.selectedRanges,_k=0,_len2=_ref1.length;_len2>_k;_k++)if(range=_ref1[_k],container=range.commonAncestor,$(container).hasClass("annotator-hl")&&(container=$(container).parents("[class!=annotator-hl]")[0]),this.isAnnotator(container))return;return event&&this.selectedRanges.length?this.adder.css(Util.mousePosition(event,this.wrapper[0])).show():this.adder.hide()}},Annotator.prototype.isAnnotator=function(element){return!!$(element).parents().addBack().filter("[class^=annotator-]").not(this.wrapper).length},Annotator.prototype.onHighlightMouseover=function(event){var annotations;return this.clearViewerHideTimer(),this.mouseIsDown||this.viewer.isShown()?!1:(annotations=$(event.target).parents(".annotator-hl").addBack().map(function(){return $(this).data("annotation")}),this.showViewer($.makeArray(annotations),Util.mousePosition(event,this.wrapper[0])))},Annotator.prototype.onAdderMousedown=function(event){return null!=event&&event.preventDefault(),this.ignoreMouseup=!0},Annotator.prototype.onAdderClick=function(event){var annotation,cancel,cleanup,position,save;return null!=event&&event.preventDefault(),position=this.adder.position(),this.adder.hide(),annotation=this.setupAnnotation(this.createAnnotation()),$(annotation.highlights).addClass("annotator-hl-temporary"),save=function(_this){return function(){return cleanup(),$(annotation.highlights).removeClass("annotator-hl-temporary"),_this.publish("annotationCreated",[annotation])}}(this),cancel=function(_this){return function(){return cleanup(),_this.deleteAnnotation(annotation)}}(this),cleanup=function(_this){return function(){return _this.unsubscribe("annotationEditorHidden",cancel),_this.unsubscribe("annotationEditorSubmit",save)}}(this),this.subscribe("annotationEditorHidden",cancel),this.subscribe("annotationEditorSubmit",save),this.showEditor(annotation,position)},Annotator.prototype.onEditAnnotation=function(annotation){var cleanup,offset,update;return offset=this.viewer.element.position(),update=function(_this){return function(){return cleanup(),_this.updateAnnotation(annotation)}}(this),cleanup=function(_this){return function(){return _this.unsubscribe("annotationEditorHidden",cleanup),_this.unsubscribe("annotationEditorSubmit",update)}}(this),this.subscribe("annotationEditorHidden",cleanup),this.subscribe("annotationEditorSubmit",update),this.viewer.hide(),this.showEditor(annotation,offset)},Annotator.prototype.onDeleteAnnotation=function(annotation){return this.viewer.hide(),this.deleteAnnotation(annotation)},Annotator}(Delegator),Annotator.Plugin=function(_super){function Plugin(element,options){Plugin.__super__.constructor.apply(this,arguments)}return __extends(Plugin,_super),Plugin.prototype.pluginInit=function(){},Plugin.prototype.destroy=function(){return this.removeEvents()},Plugin}(Delegator),g=Util.getGlobal(),null==(null!=(_ref1=g.document)?_ref1.evaluate:void 0)&&$.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==g.getSelection&&$.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==g.JSON&&$.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==g.Node&&(g.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),Annotator.$=$,Annotator.Delegator=Delegator,Annotator.Range=Range,Annotator.Util=Util,Annotator._instances=[],Annotator._t=_t,Annotator.supported=function(){return function(){return!!this.getSelection}()},Annotator.noConflict=function(){return Util.getGlobal().Annotator=_Annotator,this},$.fn.annotator=function(options){var args;return args=Array.prototype.slice.call(arguments,1),this.each(function(){var instance;return instance=$.data(this,"annotator"),instance?options&&instance[options].apply(instance,args):(instance=new Annotator(this,options),$.data(this,"annotator",instance))})},this.Annotator=Annotator,Annotator.Widget=function(_super){function Widget(element,options){Widget.__super__.constructor.apply(this,arguments),this.classes=$.extend({},Annotator.Widget.prototype.classes,this.classes)}return __extends(Widget,_super),Widget.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},Widget.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},Widget.prototype.checkOrientation=function(){var current,offset,viewport,widget,window;return this.resetOrientation(),window=$(Annotator.Util.getGlobal()),widget=this.element.children(":first"),offset=widget.offset(),viewport={top:window.scrollTop(),right:window.width()+window.scrollLeft()},current={top:offset.top,right:offset.left+widget.width()},current.top-viewport.top<0&&this.invertY(),current.right-viewport.right>0&&this.invertX(),this},Widget.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},Widget.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},Widget.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},Widget.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},Widget.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},Widget}(Delegator),Annotator.Editor=function(_super){function Editor(options){this.onCancelButtonMouseover=__bind(this.onCancelButtonMouseover,this),this.processKeypress=__bind(this.processKeypress,this),this.submit=__bind(this.submit,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),Editor.__super__.constructor.call(this,$(this.html)[0],options),this.fields=[],this.annotation={}}return __extends(Editor,_super),Editor.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},Editor.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},Editor.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+_t("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+_t("Save")+"</a>\n    </div>\n  </form>\n</div>",Editor.prototype.options={},Editor.prototype.show=function(event){return Annotator.Util.preventEventDefault(event),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},Editor.prototype.hide=function(event){return Annotator.Util.preventEventDefault(event),this.element.addClass(this.classes.hide),this.publish("hide")},Editor.prototype.load=function(annotation){var field,_k,_len2,_ref2;for(this.annotation=annotation,this.publish("load",[this.annotation]),_ref2=this.fields,_k=0,_len2=_ref2.length;_len2>_k;_k++)field=_ref2[_k],field.load(field.element,this.annotation);return this.show()},Editor.prototype.submit=function(event){var field,_k,_len2,_ref2;for(Annotator.Util.preventEventDefault(event),_ref2=this.fields,_k=0,_len2=_ref2.length;_len2>_k;_k++)field=_ref2[_k],field.submit(field.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},Editor.prototype.addField=function(options){var element,field,input;switch(field=$.extend({id:"annotator-field-"+Annotator.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},options),input=null,element=$('<li class="annotator-item" />'),field.element=element[0],field.type){case"textarea":input=$("<textarea />");break;case"input":case"checkbox":input=$("<input />");break;case"select":input=$("<select />")}return element.append(input),input.attr({id:field.id,placeholder:field.label}),"checkbox"===field.type&&(input[0].type="checkbox",element.addClass("annotator-checkbox"),element.append($("<label />",{"for":field.id,html:field.label}))),this.element.find("ul:first").append(element),this.fields.push(field),field.element},Editor.prototype.checkOrientation=function(){var controls,list;return Editor.__super__.checkOrientation.apply(this,arguments),list=this.element.find("ul"),controls=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?controls.insertBefore(list):controls.is(":first-child")&&controls.insertAfter(list),this},Editor.prototype.processKeypress=function(event){return 27===event.keyCode?this.hide():13!==event.keyCode||event.shiftKey?void 0:this.submit()},Editor.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},Editor.prototype.setupDraggables=function(){var classes,controls,cornerItem,editor,mousedown,onMousedown,onMousemove,onMouseup,resize,textarea,throttle;return this.element.find(".annotator-resize").remove(),cornerItem=this.element.hasClass(this.classes.invert.y)?this.element.find(".annotator-item:last"):this.element.find(".annotator-item:first"),cornerItem&&$('<span class="annotator-resize"></span>').appendTo(cornerItem),mousedown=null,classes=this.classes,editor=this.element,textarea=null,resize=editor.find(".annotator-resize"),controls=editor.find(".annotator-controls"),throttle=!1,onMousedown=function(event){return event.target===this?(mousedown={element:this,top:event.pageY,left:event.pageX},textarea=editor.find("textarea:first"),$(window).bind({"mouseup.annotator-editor-resize":onMouseup,"mousemove.annotator-editor-resize":onMousemove}),event.preventDefault()):void 0},onMouseup=function(){return mousedown=null,$(window).unbind(".annotator-editor-resize")},onMousemove=function(_this){return function(event){var diff,directionX,directionY,height,width;return mousedown&&throttle===!1?(diff={top:event.pageY-mousedown.top,left:event.pageX-mousedown.left},mousedown.element===resize[0]?(height=textarea.outerHeight(),width=textarea.outerWidth(),directionX=editor.hasClass(classes.invert.x)?-1:1,directionY=editor.hasClass(classes.invert.y)?1:-1,textarea.height(height+diff.top*directionY),textarea.width(width+diff.left*directionX),textarea.outerHeight()!==height&&(mousedown.top=event.pageY),textarea.outerWidth()!==width&&(mousedown.left=event.pageX)):mousedown.element===controls[0]&&(editor.css({top:parseInt(editor.css("top"),10)+diff.top,left:parseInt(editor.css("left"),10)+diff.left}),mousedown.top=event.pageY,mousedown.left=event.pageX),throttle=!0,setTimeout(function(){return throttle=!1},1e3/60)):void 0}}(this),resize.bind("mousedown",onMousedown),controls.bind("mousedown",onMousedown)},Editor}(Annotator.Widget),Annotator.Viewer=function(_super){function Viewer(options){this.onDeleteClick=__bind(this.onDeleteClick,this),this.onEditClick=__bind(this.onEditClick,this),this.load=__bind(this.load,this),this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),Viewer.__super__.constructor.call(this,$(this.html.element)[0],options),this.item=$(this.html.item)[0],this.fields=[],this.annotations=[]}return __extends(Viewer,_super),Viewer.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},Viewer.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},Viewer.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},Viewer.prototype.options={readOnly:!1},Viewer.prototype.show=function(event){var controls;return Annotator.Util.preventEventDefault(event),controls=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(_this){return function(){return controls.removeClass(_this.classes.showControls)}}(this),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},Viewer.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},Viewer.prototype.hide=function(event){return Annotator.Util.preventEventDefault(event),this.element.addClass(this.classes.hide),this.publish("hide")},Viewer.prototype.load=function(annotations){var annotation,controller,controls,del,edit,element,field,item,link,links,list,_k,_l,_len2,_len3,_ref2,_ref3;for(this.annotations=annotations||[],list=this.element.find("ul:first").empty(),_ref2=this.annotations,_k=0,_len2=_ref2.length;_len2>_k;_k++)for(annotation=_ref2[_k],item=$(this.item).clone().appendTo(list).data("annotation",annotation),controls=item.find(".annotator-controls"),link=controls.find(".annotator-link"),edit=controls.find(".annotator-edit"),del=controls.find(".annotator-delete"),links=new LinkParser(annotation.links||[]).get("alternate",{type:"text/html"}),0===links.length||null==links[0].href?link.remove():link.attr("href",links[0].href),this.options.readOnly?(edit.remove(),del.remove()):controller={showEdit:function(){return edit.removeAttr("disabled")},hideEdit:function(){return edit.attr("disabled","disabled")},showDelete:function(){return del.removeAttr("disabled")},hideDelete:function(){return del.attr("disabled","disabled")}},_ref3=this.fields,_l=0,_len3=_ref3.length;_len3>_l;_l++)field=_ref3[_l],element=$(field.element).clone().appendTo(item)[0],field.load(element,annotation,controller);return this.publish("load",[this.annotations]),this.show()},Viewer.prototype.addField=function(options){var field;return field=$.extend({load:function(){}},options),field.element=$("<div />")[0],this.fields.push(field),field.element,this},Viewer.prototype.onEditClick=function(event){return this.onButtonClick(event,"edit")},Viewer.prototype.onDeleteClick=function(event){return this.onButtonClick(event,"delete")},Viewer.prototype.onButtonClick=function(event,type){var item;return item=$(event.target).parents(".annotator-annotation"),this.publish(type,[item.data("annotation")])},Viewer}(Annotator.Widget),LinkParser=function(){function LinkParser(data){this.data=data}return LinkParser.prototype.get=function(rel,cond){var d,k,keys,match,v,_k,_len2,_ref2,_results;for(null==cond&&(cond={}),cond=$.extend({},cond,{rel:rel}),keys=function(){var _results;_results=[];for(k in cond)__hasProp.call(cond,k)&&(v=cond[k],_results.push(k));return _results}(),_ref2=this.data,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)d=_ref2[_k],match=keys.reduce(function(m,k){return m&&d[k]===cond[k]},!0),match&&_results.push(d);return _results},LinkParser}(),Annotator=Annotator||{},Annotator.Notification=function(_super){function Notification(options){this.hide=__bind(this.hide,this),this.show=__bind(this.show,this),Notification.__super__.constructor.call(this,$(this.options.html).appendTo(document.body)[0],options)}return __extends(Notification,_super),Notification.prototype.events={click:"hide"},Notification.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},Notification.prototype.show=function(message,status){return null==status&&(status=Annotator.Notification.INFO),this.currentStatus=status,$(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(Util.escape(message||"")),setTimeout(this.hide,5e3),this},Notification.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=Annotator.Notification.INFO),$(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},Notification}(Delegator),Annotator.Notification.INFO="info",Annotator.Notification.SUCCESS="success",Annotator.Notification.ERROR="error",$(function(){var notification;return notification=new Annotator.Notification,Annotator.showNotification=notification.show,Annotator.hideNotification=notification.hide}),Annotator.Plugin.Unsupported=function(_super){function Unsupported(){return Unsupported.__super__.constructor.apply(this,arguments)}return __extends(Unsupported,_super),Unsupported.prototype.options={message:Annotator._t("Sorry your current browser does not support the Annotator")},Unsupported.prototype.pluginInit=function(){return Annotator.supported()?void 0:$(function(_this){return function(){return Annotator.showNotification(_this.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject?$("html").addClass("ie6"):void 0}}(this))},Unsupported}(Annotator.Plugin),createDateFromISO8601=function(string){var d,date,offset,regexp,time,_ref2;return regexp="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",d=string.match(new RegExp(regexp)),offset=0,date=new Date(d[1],0,1),d[3]&&date.setMonth(d[3]-1),d[5]&&date.setDate(d[5]),d[7]&&date.setHours(d[7]),d[8]&&date.setMinutes(d[8]),d[10]&&date.setSeconds(d[10]),d[12]&&date.setMilliseconds(1e3*Number("0."+d[12])),d[14]&&(offset=60*Number(d[16])+Number(d[17]),offset*=null!=(_ref2="-"===d[15])?_ref2:{1:-1}),offset-=date.getTimezoneOffset(),time=Number(date)+60*offset*1e3,date.setTime(Number(time)),date},base64Decode=function(data){var ac,b64,bits,dec,h1,h2,h3,h4,i,o1,o2,o3,tmp_arr;if("undefined"!=typeof atob&&null!==atob)return atob(data);if(b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=0,ac=0,dec="",tmp_arr=[],!data)return data;for(data+="";i<data.length;)h1=b64.indexOf(data.charAt(i++)),h2=b64.indexOf(data.charAt(i++)),h3=b64.indexOf(data.charAt(i++)),h4=b64.indexOf(data.charAt(i++)),bits=h1<<18|h2<<12|h3<<6|h4,o1=bits>>16&255,o2=bits>>8&255,o3=255&bits,64===h3?tmp_arr[ac++]=String.fromCharCode(o1):64===h4?tmp_arr[ac++]=String.fromCharCode(o1,o2):tmp_arr[ac++]=String.fromCharCode(o1,o2,o3);return tmp_arr.join("")},base64UrlDecode=function(data){var i,m,_k,_ref2;if(m=data.length%4,0!==m)for(i=_k=0,_ref2=4-m;_ref2>=0?_ref2>_k:_k>_ref2;i=_ref2>=0?++_k:--_k)data+="=";return data=data.replace(/-/g,"+"),data=data.replace(/_/g,"/"),base64Decode(data)},parseToken=function(token){var head,payload,sig,_ref2;return _ref2=token.split("."),head=_ref2[0],payload=_ref2[1],sig=_ref2[2],JSON.parse(base64UrlDecode(payload))},Annotator.Plugin.Auth=function(_super){function Auth(element,options){Auth.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return __extends(Auth,_super),Auth.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},Auth.prototype.requestToken=function(){return this.requestInProgress=!0,$.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done(function(_this){return function(data,status,xhr){return _this.setToken(data)}}(this)).fail(function(_this){return function(xhr,status,err){var msg;return msg=Annotator._t("Couldn't get auth token:"),console.error(""+msg+" "+err,xhr),Annotator.showNotification(""+msg+" "+xhr.responseText,Annotator.Notification.ERROR)}}(this)).always(function(_this){return function(){return _this.requestInProgress=!1}}(this))},Auth.prototype.setToken=function(token){var _results;if(this.token=token,this._unsafeToken=parseToken(token),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout(function(_this){return function(){return _this.requestToken()}}(this),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),_results=[];this.waitingForToken.length>0;)_results.push(this.waitingForToken.pop()(this._unsafeToken));return _results}return console.warn(Annotator._t("Didn't get a valid token.")),this.options.autoFetch?(console.warn(Annotator._t("Getting a new token in 10s.")),setTimeout(function(_this){return function(){return _this.requestToken()}}(this),1e4)):void 0},Auth.prototype.haveValidToken=function(){var allFields;return allFields=this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey,allFields&&this.timeToExpiry()>0?!0:!1},Auth.prototype.timeToExpiry=function(){var expiry,issue,now,timeToExpiry;return now=(new Date).getTime()/1e3,issue=createDateFromISO8601(this._unsafeToken.issuedAt).getTime()/1e3,expiry=issue+this._unsafeToken.ttl,timeToExpiry=expiry-now,timeToExpiry>0?timeToExpiry:0},Auth.prototype.updateHeaders=function(){var current;return current=this.element.data("annotator:headers"),this.element.data("annotator:headers",$.extend(current,{"x-annotator-auth-token":this.token}))},Auth.prototype.withToken=function(callback){return null!=callback?this.haveValidToken()?callback(this._unsafeToken):(this.waitingForToken.push(callback),this.requestInProgress?void 0:this.requestToken()):void 0},Auth}(Annotator.Plugin),Annotator.Plugin.Store=function(_super){function Store(element,options){this._onError=__bind(this._onError,this),this._onLoadAnnotationsFromSearch=__bind(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=__bind(this._onLoadAnnotations,this),this._getAnnotations=__bind(this._getAnnotations,this),Store.__super__.constructor.apply(this,arguments),this.annotations=[]}return __extends(Store,_super),Store.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},Store.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},Store.prototype.pluginInit=function(){return Annotator.supported()?this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations():void 0},Store.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},Store.prototype.annotationCreated=function(annotation){return __indexOf.call(this.annotations,annotation)<0?(this.registerAnnotation(annotation),this._apiRequest("create",annotation,function(_this){return function(data){return null==data.id&&console.warn(Annotator._t("Warning: No ID returned from server for annotation "),annotation),_this.updateAnnotation(annotation,data)}}(this))):this.updateAnnotation(annotation,{})},Store.prototype.annotationUpdated=function(annotation){return __indexOf.call(this.annotations,annotation)>=0?this._apiRequest("update",annotation,function(_this){return function(data){return _this.updateAnnotation(annotation,data)}}(this)):void 0},Store.prototype.annotationDeleted=function(annotation){return __indexOf.call(this.annotations,annotation)>=0?this._apiRequest("destroy",annotation,function(_this){return function(){return _this.unregisterAnnotation(annotation)}}(this)):void 0},Store.prototype.registerAnnotation=function(annotation){return this.annotations.push(annotation)},Store.prototype.unregisterAnnotation=function(annotation){return this.annotations.splice(this.annotations.indexOf(annotation),1)},Store.prototype.updateAnnotation=function(annotation,data){return __indexOf.call(this.annotations,annotation)<0?console.error(Annotator._t("Trying to update unregistered annotation!")):$.extend(annotation,data),$(annotation.highlights).data("annotation",annotation)},Store.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},Store.prototype._onLoadAnnotations=function(data){var a,annotation,annotationMap,newData,_k,_l,_len2,_len3,_ref2;for(null==data&&(data=[]),annotationMap={},_ref2=this.annotations,_k=0,_len2=_ref2.length;_len2>_k;_k++)a=_ref2[_k],annotationMap[a.id]=a;for(newData=[],_l=0,_len3=data.length;_len3>_l;_l++)a=data[_l],annotationMap[a.id]?(annotation=annotationMap[a.id],this.updateAnnotation(annotation,a)):newData.push(a);return this.annotations=this.annotations.concat(newData),this.annotator.loadAnnotations(newData.slice())},Store.prototype.loadAnnotationsFromSearch=function(searchOptions){return this._apiRequest("search",searchOptions,this._onLoadAnnotationsFromSearch)},Store.prototype._onLoadAnnotationsFromSearch=function(data){return null==data&&(data={}),this._onLoadAnnotations(data.rows||[])},Store.prototype.dumpAnnotations=function(){var ann,_k,_len2,_ref2,_results;for(_ref2=this.annotations,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)ann=_ref2[_k],_results.push(JSON.parse(this._dataFor(ann)));return _results},Store.prototype._apiRequest=function(action,obj,onSuccess){var id,options,request,url;return id=obj&&obj.id,url=this._urlFor(action,id),options=this._apiRequestOptions(action,obj,onSuccess),request=$.ajax(url,options),request._id=id,request._action=action,request},Store.prototype._apiRequestOptions=function(action,obj,onSuccess){var data,method,opts;return method=this._methodFor(action),opts={type:method,headers:this.element.data("annotator:headers"),dataType:"json",success:onSuccess||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==method&&"DELETE"!==method||(opts.headers=$.extend(opts.headers,{"X-HTTP-Method-Override":method}),opts.type="POST"),"search"===action?opts=$.extend(opts,{data:obj}):(data=obj&&this._dataFor(obj),this.options.emulateJSON?(opts.data={json:data},this.options.emulateHTTP&&(opts.data._method=method),opts):opts=$.extend(opts,{data:data,contentType:"application/json; charset=utf-8"}))},Store.prototype._urlFor=function(action,id){var url;return url=null!=this.options.prefix?this.options.prefix:"",url+=this.options.urls[action],url=url.replace(/\/:id/,null!=id?"/"+id:""),url=url.replace(/:id/,null!=id?id:"")},Store.prototype._methodFor=function(action){var table;return table={create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"},table[action]},Store.prototype._dataFor=function(annotation){var data,highlights;return highlights=annotation.highlights,delete annotation.highlights,$.extend(annotation,this.options.annotationData),data=JSON.stringify(annotation),highlights&&(annotation.highlights=highlights),data},Store.prototype._onError=function(xhr){var action,message;switch(action=xhr._action,message=Annotator._t("Sorry we could not ")+action+Annotator._t(" this annotation"),"search"===xhr._action?message=Annotator._t("Sorry we could not search the store for annotations"):"read"!==xhr._action||xhr._id||(message=Annotator._t("Sorry we could not ")+action+Annotator._t(" the annotations from the store")),xhr.status){case 401:message=Annotator._t("Sorry you are not allowed to ")+action+Annotator._t(" this annotation");break;case 404:message=Annotator._t("Sorry we could not connect to the annotations store");break;case 500:message=Annotator._t("Sorry something went wrong with the annotation store")}return Annotator.showNotification(message,Annotator.Notification.ERROR),console.error(Annotator._t("API request failed:")+(" '"+xhr.status+"'"))},Store}(Annotator.Plugin),Annotator.Plugin.Permissions=function(_super){function Permissions(element,options){this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateViewer=__bind(this.updateViewer,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),
this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),Permissions.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return __extends(Permissions,_super),Permissions.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},Permissions.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(user){return user},userString:function(user){return user},userAuthorize:function(action,annotation,user){var token,tokens,_k,_len2;if(annotation.permissions){if(tokens=annotation.permissions[action]||[],0===tokens.length)return!0;for(_k=0,_len2=tokens.length;_len2>_k;_k++)if(token=tokens[_k],this.userId(user)===token)return!0;return!1}return annotation.user?user?this.userId(user)===this.userId(annotation.user):!1:!0},user:"",permissions:{read:[],update:[],"delete":[],admin:[]}},Permissions.prototype.pluginInit=function(){var createCallback,self;if(Annotator.supported())return self=this,createCallback=function(method,type){return function(field,annotation){return self[method].call(self,type,field,annotation)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),this.options.showViewPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>view</strong> this annotation"),load:createCallback("updatePermissionsField","read"),submit:createCallback("updateAnnotationPermissions","read")}),this.options.showEditPermissionsCheckbox===!0&&this.annotator.editor.addField({type:"checkbox",label:Annotator._t("Allow anyone to <strong>edit</strong> this annotation"),load:createCallback("updatePermissionsField","update"),submit:createCallback("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:Annotator._t("User"),property:"user",isFiltered:function(_this){return function(input,user){var keyword,_k,_len2,_ref2;if(user=_this.options.userString(user),!input||!user)return!1;for(_ref2=input.split(/\s*/),_k=0,_len2=_ref2.length;_len2>_k;_k++)if(keyword=_ref2[_k],-1===user.indexOf(keyword))return!1;return!0}}(this)}):void 0},Permissions.prototype.setUser=function(user){return this.user=user},Permissions.prototype.addFieldsToAnnotation=function(annotation){return annotation&&(annotation.permissions=this.options.permissions,this.user)?annotation.user=this.user:void 0},Permissions.prototype.authorize=function(action,annotation,user){return void 0===user&&(user=this.user),this.options.userAuthorize?this.options.userAuthorize.call(this.options,action,annotation,user):!0},Permissions.prototype.updatePermissionsField=function(action,field,annotation){var input;return field=$(field).show(),input=field.find("input").removeAttr("disabled"),this.authorize("admin",annotation)||field.hide(),this.authorize(action,annotation||{},null)?input.attr("checked","checked"):input.removeAttr("checked")},Permissions.prototype.updateAnnotationPermissions=function(type,field,annotation){var dataKey;return annotation.permissions||(annotation.permissions=this.options.permissions),dataKey=type+"-permissions",$(field).find("input").is(":checked")?annotation.permissions[type]=[]:annotation.permissions[type]=[this.options.userId(this.user)]},Permissions.prototype.updateViewer=function(field,annotation,controls){var user,username;return field=$(field),username=this.options.userString(annotation.user),annotation.user&&username&&"string"==typeof username?(user=Annotator.Util.escape(this.options.userString(annotation.user)),field.html(user).addClass("annotator-user")):field.remove(),controls&&(this.authorize("update",annotation)||controls.hideEdit(),!this.authorize("delete",annotation))?controls.hideDelete():void 0},Permissions.prototype._setAuthFromToken=function(token){return this.setUser(token.userId)},Permissions}(Annotator.Plugin),Annotator.Plugin.AnnotateItPermissions=function(_super){function AnnotateItPermissions(){return this._setAuthFromToken=__bind(this._setAuthFromToken,this),this.updateAnnotationPermissions=__bind(this.updateAnnotationPermissions,this),this.updatePermissionsField=__bind(this.updatePermissionsField,this),this.addFieldsToAnnotation=__bind(this.addFieldsToAnnotation,this),AnnotateItPermissions.__super__.constructor.apply(this,arguments)}return __extends(AnnotateItPermissions,_super),AnnotateItPermissions.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(user){return user.userId},userString:function(user){return user.userId},userAuthorize:function(action,annotation,user){var action_field,permissions,_ref2,_ref3,_ref4,_ref5;return permissions=annotation.permissions||{},action_field=permissions[action]||[],_ref2=this.groups.world,__indexOf.call(action_field,_ref2)>=0?!0:null!=user&&null!=user.userId&&null!=user.consumerKey?user.userId===annotation.user&&user.consumerKey===annotation.consumer?!0:(_ref3=this.groups.authenticated,__indexOf.call(action_field,_ref3)>=0?!0:user.consumerKey===annotation.consumer&&(_ref4=this.groups.consumer,__indexOf.call(action_field,_ref4)>=0)?!0:user.consumerKey===annotation.consumer&&(_ref5=user.userId,__indexOf.call(action_field,_ref5)>=0)?!0:user.consumerKey===annotation.consumer&&user.admin?!0:!1):!1},permissions:{read:["group:__world__"],update:[],"delete":[],admin:[]}},AnnotateItPermissions.prototype.addFieldsToAnnotation=function(annotation){return annotation&&(annotation.permissions=this.options.permissions,this.user)?(annotation.user=this.user.userId,annotation.consumer=this.user.consumerKey):void 0},AnnotateItPermissions.prototype.updatePermissionsField=function(action,field,annotation){var input;return field=$(field).show(),input=field.find("input").removeAttr("disabled"),this.authorize("admin",annotation)||field.hide(),this.user&&this.authorize(action,annotation||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?input.attr("checked","checked"):input.removeAttr("checked")},AnnotateItPermissions.prototype.updateAnnotationPermissions=function(type,field,annotation){var dataKey;return annotation.permissions||(annotation.permissions=this.options.permissions),dataKey=type+"-permissions",$(field).find("input").is(":checked")?annotation.permissions[type]=["read"===type?this.options.groups.world:this.options.groups.consumer]:annotation.permissions[type]=[]},AnnotateItPermissions.prototype._setAuthFromToken=function(token){return this.setUser(token)},AnnotateItPermissions}(Annotator.Plugin.Permissions),Annotator.Plugin.Filter=function(_super){function Filter(element,options){this._onPreviousClick=__bind(this._onPreviousClick,this),this._onNextClick=__bind(this._onNextClick,this),this._onFilterKeyup=__bind(this._onFilterKeyup,this),this._onFilterBlur=__bind(this._onFilterBlur,this),this._onFilterFocus=__bind(this._onFilterFocus,this),this.updateHighlights=__bind(this.updateHighlights,this);var _base;element=$(this.html.element).appendTo((null!=options?options.appendTo:void 0)||this.options.appendTo),Filter.__super__.constructor.call(this,element,options),(_base=this.options).filters||(_base.filters=[]),this.filter=$(this.html.filter),this.filters=[],this.current=0}return __extends(Filter,_super),Filter.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},Filter.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},Filter.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n</span>\n<strong>"+Annotator._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>"},Filter.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(input,property){var keyword,_k,_len2,_ref2;if(!input||!property)return!1;for(_ref2=input.split(/\s+/),_k=0,_len2=_ref2.length;_len2>_k;_k++)if(keyword=_ref2[_k],-1===property.indexOf(keyword))return!1;return!0}},Filter.prototype.pluginInit=function(){var filter,_k,_len2,_ref2;for(_ref2=this.options.filters,_k=0,_len2=_ref2.length;_len2>_k;_k++)filter=_ref2[_k],this.addFilter(filter);return this.updateHighlights(),this._setupListeners()._insertSpacer(),this.options.addAnnotationFilter===!0?this.addFilter({label:Annotator._t("Annotation"),property:"text"}):void 0},Filter.prototype.destroy=function(){var currentMargin,html;return Filter.__super__.destroy.apply(this,arguments),html=$("html"),currentMargin=parseInt(html.css("padding-top"),10)||0,html.css("padding-top",currentMargin-this.element.outerHeight()),this.element.remove()},Filter.prototype._insertSpacer=function(){var currentMargin,html;return html=$("html"),currentMargin=parseInt(html.css("padding-top"),10)||0,html.css("padding-top",currentMargin+this.element.outerHeight()),this},Filter.prototype._setupListeners=function(){var event,events,_k,_len2;for(events=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],_k=0,_len2=events.length;_len2>_k;_k++)event=events[_k],this.annotator.subscribe(event,this.updateHighlights);return this},Filter.prototype.addFilter=function(options){var f,filter;return filter=$.extend({label:"",property:"",isFiltered:this.options.isFiltered},options),function(){var _k,_len2,_ref2,_results;for(_ref2=this.filters,_results=[],_k=0,_len2=_ref2.length;_len2>_k;_k++)f=_ref2[_k],f.property===filter.property&&_results.push(f);return _results}.call(this).length||(filter.id="annotator-filter-"+filter.property,filter.annotations=[],filter.element=this.filter.clone().appendTo(this.element),filter.element.find("label").html(filter.label).attr("for",filter.id),filter.element.find("input").attr({id:filter.id,placeholder:Annotator._t("Filter by ")+filter.label+"…"}),filter.element.find("button").hide(),filter.element.data("filter",filter),this.filters.push(filter)),this},Filter.prototype.updateFilter=function(filter){var annotation,annotations,input,property,_k,_len2,_ref2;if(filter.annotations=[],this.updateHighlights(),this.resetHighlights(),input=$.trim(filter.element.find("input").val())){for(annotations=this.highlights.map(function(){return $(this).data("annotation")}),_ref2=$.makeArray(annotations),_k=0,_len2=_ref2.length;_len2>_k;_k++)annotation=_ref2[_k],property=annotation[filter.property],filter.isFiltered(input,property)&&filter.annotations.push(annotation);return this.filterHighlights()}},Filter.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},Filter.prototype.filterHighlights=function(){var activeFilters,annotation,annotations,filtered,highlights,index,uniques,_k,_len2,_ref2;for(activeFilters=$.grep(this.filters,function(filter){return!!filter.annotations.length}),filtered=(null!=(_ref2=activeFilters[0])?_ref2.annotations:void 0)||[],activeFilters.length>1&&(annotations=[],$.each(activeFilters,function(){return $.merge(annotations,this.annotations)}),uniques=[],filtered=[],$.each(annotations,function(){return-1===$.inArray(this,uniques)?uniques.push(this):filtered.push(this)})),highlights=this.highlights,index=_k=0,_len2=filtered.length;_len2>_k;index=++_k)annotation=filtered[index],highlights=highlights.not(annotation.highlights);return highlights.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},Filter.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},Filter.prototype._onFilterFocus=function(event){var input;return input=$(event.target),input.parent().addClass(this.classes.active),input.next("button").show()},Filter.prototype._onFilterBlur=function(event){var input;return event.target.value?void 0:(input=$(event.target),input.parent().removeClass(this.classes.active),input.next("button").hide())},Filter.prototype._onFilterKeyup=function(event){var filter;return filter=$(event.target).parent().data("filter"),filter?this.updateFilter(filter):void 0},Filter.prototype._findNextHighlight=function(previous){var active,annotation,current,index,next,offset,operator,resetOffset;return this.highlights.length?(offset=previous?0:-1,resetOffset=previous?-1:0,operator=previous?"lt":"gt",active=this.highlights.not("."+this.classes.hl.hide),current=active.filter("."+this.classes.hl.active),current.length||(current=active.eq(offset)),annotation=current.data("annotation"),index=active.index(current[0]),next=active.filter(":"+operator+"("+index+")").not(annotation.highlights).eq(resetOffset),next.length||(next=active.eq(resetOffset)),this._scrollToHighlight(next.data("annotation").highlights)):this},Filter.prototype._onNextClick=function(event){return this._findNextHighlight()},Filter.prototype._onPreviousClick=function(event){return this._findNextHighlight(!0)},Filter.prototype._scrollToHighlight=function(highlight){return highlight=$(highlight),this.highlights.removeClass(this.classes.hl.active),highlight.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:highlight.offset().top-(this.element.height()+20)},150)},Filter.prototype._onClearClick=function(event){return $(event.target).prev("input").val("").keyup().blur()},Filter}(Annotator.Plugin),Annotator.Plugin.Markdown=function(_super){function Markdown(element,options){this.updateTextField=__bind(this.updateTextField,this),null!=("undefined"!=typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(Markdown.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(Annotator._t("To use the Markdown plugin, you must include Showdown into the page first."))}return __extends(Markdown,_super),Markdown.prototype.events={annotationViewerTextField:"updateTextField"},Markdown.prototype.updateTextField=function(field,annotation){var text;return text=Annotator.Util.escape(annotation.text||""),$(field).html(this.convert(text))},Markdown.prototype.convert=function(text){return this.converter.makeHtml(text)},Markdown}(Annotator.Plugin),Annotator.Plugin.Tags=function(_super){function Tags(){return this.setAnnotationTags=__bind(this.setAnnotationTags,this),this.updateField=__bind(this.updateField,this),Tags.__super__.constructor.apply(this,arguments)}return __extends(Tags,_super),Tags.prototype.options={parseTags:function(string){var tags;return string=$.trim(string),tags=[],string&&(tags=string.split(/\s+/)),tags},stringifyTags:function(array){return array.join(" ")}},Tags.prototype.field=null,Tags.prototype.input=null,Tags.prototype.pluginInit=function(){return Annotator.supported()?(this.field=this.annotator.editor.addField({label:Annotator._t("Add some tags here")+"…",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:Annotator._t("Tag"),property:"tags",isFiltered:Annotator.Plugin.Tags.filterCallback}),this.input=$(this.field).find(":input")):void 0},Tags.prototype.parseTags=function(string){return this.options.parseTags(string)},Tags.prototype.stringifyTags=function(array){return this.options.stringifyTags(array)},Tags.prototype.updateField=function(field,annotation){var value;return value="",annotation.tags&&(value=this.stringifyTags(annotation.tags)),this.input.val(value)},Tags.prototype.setAnnotationTags=function(field,annotation){return annotation.tags=this.parseTags(this.input.val())},Tags.prototype.updateViewer=function(field,annotation){return field=$(field),annotation.tags&&$.isArray(annotation.tags)&&annotation.tags.length?field.addClass("annotator-tags").html(function(){var string;return string=$.map(annotation.tags,function(tag){return'<span class="annotator-tag">'+Annotator.Util.escape(tag)+"</span>"}).join(" ")}):field.remove()},Tags}(Annotator.Plugin),Annotator.Plugin.Tags.filterCallback=function(input,tags){var keyword,keywords,matches,tag,_k,_l,_len2,_len3;if(null==tags&&(tags=[]),matches=0,keywords=[],input)for(keywords=input.split(/\s+/g),_k=0,_len2=keywords.length;_len2>_k;_k++)if(keyword=keywords[_k],tags.length)for(_l=0,_len3=tags.length;_len3>_l;_l++)tag=tags[_l],-1!==tag.indexOf(keyword)&&(matches+=1);return matches===keywords.length},Annotator.prototype.setupPlugins=function(config,options){var name,opts,pluginConfig,plugins,uri,win,_k,_len2,_results;null==config&&(config={}),null==options&&(options={}),win=Annotator.Util.getGlobal(),plugins=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions"],win.Showdown&&plugins.push("Markdown"),uri=win.location.href.split(/#|\?/).shift()||"",pluginConfig={Tags:{},Filter:{filters:[{label:Annotator._t("User"),property:"user"},{label:Annotator._t("Tags"),property:"tags"}]},Auth:{tokenUrl:config.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:config.storeUrl||"http://annotateit.org/api",annotationData:{uri:uri},loadFromSearch:{uri:uri}}};for(name in options)__hasProp.call(options,name)&&(opts=options[name],__indexOf.call(plugins,name)<0&&plugins.push(name));for($.extend(!0,pluginConfig,options),_results=[],_k=0,_len2=plugins.length;_len2>_k;_k++)name=plugins[_k],name in pluginConfig&&!pluginConfig[name]?_results.push(void 0):_results.push(this.addPlugin(name,pluginConfig[name]));return _results}}.call(this);var ANNOTATION_HASH_REGEX=/^annotation_([0-9]+)$/,ANNOTATION_COMMENT_HASH_REGEX=/^annsubcomment_([0-9]+)$/,COMMENT_HASH_REGEX=/^comment_([0-9]+)-?([0-9]+)?$/;window.getAnnotationService=function(){var elem=angular.element($("html")),injector=elem.injector(),annotationService=injector.get("annotationService");return annotationService},window.getLoginPopupService=function(){var elem=angular.element($("html")),injector=elem.injector(),loginPopupService=injector.get("loginPopupService");return loginPopupService},window.getAuthService=function(){var elem=angular.element($("html")),injector=elem.injector(),AuthService=injector.get("AuthService");return AuthService},window.getBasePath=function(){var secondHashIndex,basePath=window.location.href,nonHtml5Urls=-1!==basePath.indexOf("/#/"),firstHashIndex=basePath.indexOf("#");return nonHtml5Urls?(secondHashIndex=basePath.indexOf("#",firstHashIndex+1),-1!==secondHashIndex&&(basePath=basePath.substring(0,secondHashIndex))):-1!==firstHashIndex&&(secondHashIndex=basePath.indexOf("#",firstHashIndex+1),basePath=-1!==secondHashIndex?basePath.substring(0,secondHashIndex):basePath.substring(0,firstHashIndex)),basePath},Annotator.Plugin.Madison=function(element,options){Annotator.Plugin.apply(this,arguments)},$.extend(Annotator.Plugin.Madison.prototype,new Annotator.Plugin,{events:{},options:{},pluginInit:function(){var annotationService=this.options.annotationService;this.showLoginForm=this.options.showLoginForm,this.annotator.subscribe("annotationsLoaded",function(annotations){annotations.forEach(function(annotation){annotation.highlights.forEach(function(highlight){$(highlight).attr("id","annotation_"+annotation.id),$(highlight).attr("name","annotation_"+annotation.id),annotation.link="annotation_"+annotation.id})}),annotationService.setAnnotations(annotations),annotationService.broadcastSet()}),this.annotator.subscribe("annotationCreated",function(annotation){annotationService.addAnnotation(annotation)}),this.annotator.subscribe("commentCreated",function(comment){comment=$('<div class="existing-comment"><blockquote>'+comment.text+'<div class="comment-author">'+comment.user.display_name+"</div></blockquote></div>");var currentComments=$("#current-comments");currentComments.append(comment),currentComments.removeClass("hidden"),$("#current-comments").collapse(!0)}),this.annotator.subscribe("annotationViewerTextField",function(field,annotation){0!==annotation.tags.length&&annotation.tags.forEach(function(tag){if("edit"===tag){var jField=$(field),differ=new diff_match_patch,diffs=differ.diff_main(annotation.quote,annotation.text),html=differ.diff_prettyHtml(diffs);jField.find("p").html(html)}})}),this.annotator.viewer.addField({load:function(field,annotation){this.addNoteLink(field,annotation),this.addNoteActions(field,annotation),this.addComments(field,annotation)}.bind(this)}),this.annotator.editor.submit=function(e){this.annotation._error=!1;var field,_i,_len,_ref;for(Annotator.Util.preventEventDefault(e),_ref=this.fields,_i=0,_len=_ref.length;_len>_i;_i++)field=_ref[_i],field.submit(field.element,this.annotation);return this.annotation._error!==!0?(this.publish("save",[this.annotation]),this.hide()):void 0},this.annotator.editor.addField({load:function(field,annotation){this.addEditFields(field,annotation)}.bind(this),submit:function(field,annotation){if(this.hasEditTag(annotation.tags)){var explanation=$(field).find("#explanation").val();if(""===explanation.trim())return $("#annotation-error").text("Explanation required for edits.").toggle(!0),annotation._error=!0,!1;annotation.explanation=explanation}},hasEditTag:function(tags){var hasEditTag=!1;return void 0===tags||0===tags.length?!1:(tags.forEach(function(tag){"edit"===tag&&(hasEditTag=!0)}),hasEditTag)}}),this.annotator.options.readOnly&&!this.annotator.options.discussionClosed&&this.annotator._setupDocumentEvents(),this.onAdderClickOld=this.annotator.onAdderClick,this.annotator.onAdderClick=function(event){null!==event&&event.preventDefault(),this.options.user?this.onAdderClickOld(event):(this.showLoginForm(event),this.annotator.adder.hide(),this.annotator.ignoreMouseup=!1)}.bind(this)},addEditFields:function(field,annotation){var newField=$(field),toAdd=$('<div class="annotator-editor-edit-wrapper"></div>'),buttonGroup=$('<div class="btn-group"></div>'),explanation=$('<input id="explanation" type="text" name="explanation" placeholder="Why did you make this edit?" style="display:none;" />'),annotationError=$('<p id="annotation-error" style="display:none; color:red;"></p>'),annotateButton=$('<button type="button" class="btn btn-default active">Annotate</button>').click(function(){$(this).addClass("active"),$(this).siblings().each(function(sibling){$(this).removeClass("active")}),$("#annotator-field-0").val(""),$("#annotator-field-1").val(""),$("#explanation").toggle(!1),$("#explanation").prop("required",!1),$("#annotator-error").text("").toggle(!1),$("#annotator-field-0").focus()}),editButton=$('<button type="button" class="btn btn-default">Edit</button>').click(function(){$(this).addClass("active"),$(this).siblings().each(function(sibling){$(this).removeClass("active")}),$("#annotator-field-0").val(annotation.quote),$("#annotator-field-1").val("edit "),$("#explanation").toggle(!0),$("#explanation").prop("required",!0),$("#annotator-field-0").focus()});buttonGroup.append(annotateButton,editButton),toAdd.append(buttonGroup),toAdd.append(explanation),toAdd.append(annotationError),newField.html(toAdd)},addComments:function(field,annotation){var user=this.options.user,commentsHeader=$('<div class="comment-toggle" data-toggle-"collapse" data-target="#current-comments">Comments <span id="comment-caret" class="caret caret-right"></span></button>').click(function(){$("#current-comments").collapse("toggle"),$("#comment-caret").toggleClass("caret-right")});0===$(annotation.comments).length&&commentsHeader.addClass("hidden");var currentComments=$('<div id="current-comments" class="current-comments collapse"></div>');if($.each(annotation.comments,function(index,comment){comment=$('<div class="existing-comment"><blockquote>'+comment.text+'<div class="comment-author">'+comment.user.display_name+"</div></blockquote></div>"),currentComments.append(comment)}),currentComments.ready(function(){$("#existing-comments").collapse({toggle:!1})}),user&&void 0!==user.id){var annotationComments=$('<div class="annotation-comments"></div>'),commentText=$('<input type="text" class="form-control" />'),commentSubmit=$('<button type="button" class="btn btn-primary" >Submit</button>');commentSubmit.click(function(){this.createComment(commentText,annotation)}.bind(this)),annotationComments.append(commentText),annotationComments.append(commentSubmit),$(field).append(annotationComments)}$(field).append(commentsHeader,currentComments)},addNoteActions:function(field,annotation){var user=this.options.user,annotationAction=$("<div></div>").addClass("activity-actions"),generalAction=$("<span></span>").data("annotation-id",annotation.id),annotationLike=generalAction.clone().addClass("thumbs-up").append('<span class="action-count">'+annotation.likes+"</span>"),annotationFlag=generalAction.clone().addClass("flag").append('<span class="action-count">'+annotation.flags+"</span>");if(annotationAction.append(annotationLike,annotationFlag),null!==user){annotation.user_action&&("like"===annotation.user_action?annotationLike.addClass("selected"):"flag"===annotation.user_action&&annotationFlag.addClass("selected"));var that=this;annotationLike.addClass("logged-in").click(function(){that.addLike(annotation,this)}),annotationFlag.addClass("logged-in").click(function(){that.addFlag(annotation,this)})}$(field).append(annotationAction)},addNoteLink:function(field,annotation){var annotationLink=$("<a></a>").attr("href",this.options.path+"#"+annotation.link).text("Copy Annotation Link").addClass("annotation-permalink"),noteLink=$('<div class="annotation-link"></div>'),linkPath=this.options.origin+this.options.path+"#"+annotation.link;annotationLink.attr("data-clipboard-text",linkPath);new ZeroClipboard(annotationLink);annotationLink.append(noteLink),$(field).append(annotationLink)},createComment:function(textElement,annotation){var user=this.options.user,doc=this.options.doc,text=textElement.val();textElement.val("");var comment={text:text,user:user};$.post("/api/docs/"+doc.id+"/annotations/"+annotation.id+"/comments",{comment:comment},function(){return annotation.comments.push(comment),this.annotator.publish("commentCreated",comment)}.bind(this))},addLike:function(annotation,element){var doc=this.options.doc;$.post("/api/docs/"+doc.id+"/annotations/"+annotation.id+"/likes",function(data){element=$(element),element.children(".action-count").text(data.likes),element.siblings("span").removeClass("selected"),data.action?element.addClass("selected"):element.removeClass("selected"),element.siblings(".thumbs-up").children(".action-count").text(data.likes),element.siblings(".flag").children(".action-count").text(data.flags),annotation.likes=data.likes,annotation.flags=data.flags,annotation.user_action="like"})},addFlag:function(annotation,element){var doc=this.options.doc;$.post("/api/docs/"+doc.id+"/annotations/"+annotation.id+"/flags",function(data){element=$(element),element.children(".action-count").text(data.flags),element.siblings("span").removeClass("selected"),data.action?element.addClass("selected"):element.removeClass("selected"),element.siblings(".thumbs-up").children(".action-count").text(data.likes),annotation.likes=data.likes,annotation.flags=data.flags,annotation.user_action="flag"})}});
//# sourceMappingURL=annotator.map